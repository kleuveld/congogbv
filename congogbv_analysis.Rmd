---
title: Data analysis for Sexual violence, conflict, and female empowerment
author: Koen Leuveld
output: pdf_document
#bibliography: literature/references.bib


#more info:
#https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf
---

# Intro

This rmarkdown file analyses data, and prepares input tables for the paper. These
input tables do not contain any formatting, just the coefficients. The paper itself
will do the formatting. This means that the input tables can go on GitHub, even if 
the raw data itself can't, and GitHub can thus build the paper.

# Load packages and data

For now, I will just use the Stata data as prepared by `congogbv_dataprep.do`:

```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}

library(tidyverse)
library(haven)
library(here)


cleandata <- read_dta(here("data/clean/analysis.dta"))
col_labels <- map_chr(cleandata,function(x) coalesce(attributes(x)$label,""))


tibble(Variable = colnames(cleandata),
       label = col_labels) %>%
write_csv(here("tables/cleandata_collabels.csv"))

# to extract:
# col_labels <-
#   read_csv(here("tables/cleandata_collabels.csv")) %>%
#   pull(label) %>%
#   set_names(read_csv(here("tables/cleandata_collabels.csv")) %>% pull(Variable))



dhs <- read_dta(here("data/clean/dhs.dta"))

```

# Tables

## Table 1

Then I create Table 1. For now it's pivoted compared to the orignal, but that's fine.

```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}

wgt_mean <- function(data,weights,digits=2){
   num(sum(data * weights)/sum(weights),digits=digits)
}

dhs_national <-
  dhs %>% 
  summarize(across(.cols = c(agewife,tinroof:eduwife_sec),
                         .fns  = ~wgt_mean(.x,wgt))) %>%
  mutate(label = "dhs_national")

dhs_skivu <-
  dhs %>% 
  filter(province == 11) %>%
  summarize(across(.cols = c(agewife,tinroof:eduwife_sec),
                         .fns  = ~wgt_mean(.x,wgt)))%>%
  mutate(label = "dhs_skivu")

sample_full <-
cleandata %>% 
summarize(across(.cols = c(agewife,tinroof,eduwife_prim,eduwife_sec),
                .fns = ~mean(.x, na.rm = TRUE) %>% num(digits = 2)))%>%
  mutate(label = "sample_full")

sample_gendermodule <-
cleandata %>% 
  filter(!is.na(ball5)) %>%
  summarize(across(.cols = c(agewife,tinroof,eduwife_prim,eduwife_sec),
                  .fns = ~mean(.x, na.rm = TRUE) %>% num(digits = 2)))%>%
  mutate(label = "sample_gendermodule")

rbind(dhs_national,dhs_skivu,sample_full,sample_gendermodule) %>%
write_csv(here("tables/table1.csv"))


```


## Table 2

I need to add the labels still:

```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}

library(janitor)

cleandata %>% 
  tabyl(riskwifestatus,riskhusbandstatus) %>%
  adorn_totals(c("row", "col")) %>%
  write_csv(here("tables/table2.csv"))

```

## Table 3

Payouts

## Table 4

```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}



#define function to get summ stats
get_summ_stats <- function(.df, by = NULL, overall = NULL) {
  
  #this expands the data frame to include an "overall" treatment condition
  if (!missing(by)) {

    if (!is.null(overall)) {
      .df <- 
        bind_rows(.df, .df %>% mutate({{ by }} := overall ))
    }

    .df <- 
      .df %>%
      group_by( {{ by }} )
  }

  .df %>%
    summarize(across(everything(),
                       list(
                            #label = ~coalesce(attributes(.x)$label,""),
                            n =  ~sum(!is.na(.x)),
                            nmiss =  ~sum(is.na(.x)),
                            mean = ~mean(.x,na.rm=TRUE),
                            sd = ~sd(.x,na.rm=TRUE),
                            min =  ~min(.x,na.rm=TRUE),
                            max =  ~max(.x,na.rm=TRUE),
                            iqr =  ~IQR(.x,na.rm=TRUE)),
                        .names =  "{.col}-{.fn}"))   %>%
  pivot_longer(cols = - {{ by }} ,
               names_to = c("Variable",".value"),
               names_sep="-") 

}

sample <- 
  cleandata %>%
  filter(!is.na(ball5)) %>%
  mutate(Treatment = ifelse(ball5," Treatment","  Control")) %>%
  select(Treatment, numballs,victimproplost, victimfamlost, acledviolence10)




sample %>%  
  get_summ_stats(by= Treatment, overall = "Overall") %>%
  write_csv(here("tables/summstats.csv"))


#this function returns a string to put in a column of differences
get_diffs <- function(.df,y,x){

  reg <-  lm(y~ x) %>% broom::tidy()

  coeff = round(reg[2,2],2)
  p <- reg[2,5]

  stars = case_when(p < 0.001 ~ "***",
                    p < 0.01 ~ "**",
                    p < 0.05 ~ "*",
                    .default = "" )

  paste0(coeff,stars)
}


sample %>%
  select(-Treatment) %>%
  summarize(across(everything(),
                   .fns = function(x) get_diffs(.,.$x,as.factor(sample$Treatment)))) %>%
  pivot_longer(cols =everything(),
               names_to = "Variable",
               values_to="Difference")  %>%
  write_csv(here("tables/summstats_diffs.csv"))

#to the Rmd


library(flextable)


# flextable orders the variables alphabetically, but I want to preserve the order
# because the variabe order is the same in summstats and difcol, I can just use sequential numbers
# making sure to do the same with the labels 
numvars <- read_csv(here("tables/summstats_diffs.csv")) %>% nrow()
numtreatment <- 3

summstats <- 
  read_csv(here("tables/summstats.csv")) %>%
  left_join(read_csv(here("tables/cleandata_collabels.csv"))) %>%
  mutate(Variable = str_pad(rep(1:numvars,numtreatment),2,pad="0")) 

difcol <- 
  read_csv(here("tables/summstats_diffs.csv")) %>%
  mutate(Variable = str_pad(1:numvars,2,pad="0"))

labels <- summstats %>% pull(label) %>% unique()
names(labels) <- str_pad(1:numvars,2,pad="0")

tab <- 
summstats %>%
  tabulator(rows = "Variable",
            columns = "Treatment",
            datasup_last = difcol,
            `N` = as_paragraph(as_chunk(n,digits=0)),
            `Mean (SD)` =  as_paragraph(as_chunk(fmt_avg_dev(mean, sd, digit1=2,digit2 = 2)))) %>%
  as_flextable() %>%
  labelizor(j = "Variable", labels = labels, part = "all") %>% 
  fix_border_issues() %>%
  autofit()



```

## Table 5: Conflict Exposure by Territory



```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}


create_codebook(cleandata) %>% View()

cleandata %>%
  select(victimproplost,victimfamlost,acledviolence10, territory) %>%
  mutate(Territory = case_when(territory == 1 | territory == 2 ~ " Kabare/Bagira",
                               territory == 3 ~ " Uvira",
                               territory == 4 ~ " Fizi")) %>%
  select(-territory) %>%
  get_summ_stats(by= Territory, overall = "Overall") %>%
  write_csv(here("tables/violence_by_territory.csv"))

# To Paper

read_csv(here("tables/violence_by_territory.csv")) %>%
  tabulator(rows = "Variable",
            columns = "Territory",
            `Mean (SD)` =  as_paragraph(as_chunk(fmt_avg_dev(mean, sd, digit1=2,digit2 = 2)))) %>%
  as_flextable() %>%
  labelizor(j = "Variable", labels = col_labels, part = "all") %>% 
  fix_border_issues() %>%
  autofit()



```


## Table 6

```{r eval=TRUE, include = TRUE, echo=TRUE, warning=TRUE, error=TRUE, message=FALSE}

library(estimatr)




get_means <- function(.df, var){
.df %>%
  select(numballs,Treatment,{{ var }})   %>%
  group_by(Treatment,{{ var }}) %>%
  summarize(across(numballs, ~mean(.x, na.rm = TRUE))) %>%
  mutate({{ var }} := as.character(as_factor({{ var }}))) %>%
  pivot_longer({{ var }},
               names_to = "var",
               values_to = "group") %>%
  filter(!is.na(group)) %>%
  mutate(stat = " Mean") %>%
  select(everything(), value = numballs,stat_subgroup = Treatment)
}

df1 <- get_means(sample,victimproplost)






get_meandiffs <- function(.df,var){
  meandiff_regress <- function(.df){
    .df %>%
      lm_robust(numballs ~ Treatment, data = .) %>%
      broom::tidy() %>%
      filter(term == "Treatment Treatment") %>%
      select(estimate,std.error,p.value)
  }

  .df <- 
    .df %>% 
    mutate( {{ var }} := as.character(as_factor( {{ var }} ))) 

  splitvector <- .df %>% pull( {{ var }} )
  
  .df %>%
    split(splitvector) %>%
    map(meandiff_regress) %>%
    imap(~mutate(.x, group = .y)) %>%
    reduce(bind_rows) %>% 
    pivot_longer(!group,
                 names_to = "stat_subgroup",
                 values_to = "value") %>%
    mutate(stat = "Difference in means") %>%
    mutate(var = rlang::quo_text(enquo(var)))


}


df2 <- get_meandiffs(sample,victimproplost)


meandiff_did <- function(.df,var){

  data <- 
    .df %>% 
    select(numballs,Treatment, {{ var }})

  y <- data[[1]]
  treat <- data[[2]]
  x <- data[[3]]

  lm_robust(y ~ treat *  x)%>%
      broom::tidy() %>%
      filter(term == "treat Treatment:x") %>%
      select(estimate,std.error,p.value) %>%
      pivot_longer(everything(),
                 names_to = "stat_subgroup",
                 values_to = "value")  %>%
      mutate(group = "diff in diff",
             stat = "Difference in means",
             var = rlang::quo_text(enquo(var)))

}

df3 <- meandiff_did(sample,victimproplost)

bind_rows(df1,df2,df3) %>%
  tabulator(rows = c("var","group"),
            columns = c("stat","stat_subgroup"),
            `Mean` =  as_paragraph(as_chunk(value,digits=2))) %>%
  as_flextable() %>%
  labelizor(j = "var", labels = col_labels, part = "all") 




get_mean_diff(sample)

  get_summ_stats(by = c(Treatment,victimproplost))

  

get_string <- function(.df,var){
  rlang::quo_text(enquo(var))
}

get_string(cleandata,victimproplost)


```